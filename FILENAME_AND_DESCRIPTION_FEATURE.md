# 文件名编辑和描述显示功能

## 📋 新功能说明

### 1️⃣ 图片详情页面 - 文件名编辑
- ✅ 可以在图片详情页面编辑文件名
- ✅ 扩展名自动保留，不可修改
- ✅ 实时验证：不允许空文件名和非法字符
- ✅ 点击"编辑"按钮开始编辑，点击"保存"完成修改

### 2️⃣ 相册页面 - 描述显示
- ✅ 在图片卡片的标签下方显示描述
- ✅ 超过50字自动截断，显示省略号
- ✅ 鼠标悬停显示完整描述（title 提示）

### 3️⃣ 上传页面 - 描述输入
- ✅ 添加"添加描述"开关
- ✅ 开启后可为本批次图片添加统一描述
- ✅ 支持最多200字的描述
- ✅ 显示字数统计

## 🔧 实现细节

### 前端修改

#### 1. ImageDetailView.vue - 图片详情页面
**位置**: `front/src/views/ImageDetailView.vue`

**新增功能**:
- 文件名显示改为可编辑输入框
- 扩展名以后缀形式只读显示
- 添加"编辑"/"保存"按钮切换编辑状态
- 文件名验证：
  - 不能为空
  - 不能包含 `<>:"/\|?*` 等非法字符

**使用方法**:
1. 进入图片详情页面
2. 在"文件名"字段，点击"编辑"按钮
3. 修改文件名（扩展名自动保留）
4. 点击"保存"按钮完成修改

**示例**:
```
原文件名: 风景照片.jpg
点击编辑 → 输入框显示: 风景照片 [.jpg]
修改为: 杭州西湖
保存后: 杭州西湖.jpg
```

#### 2. GalleryView.vue - 相册页面
**位置**: `front/src/views/GalleryView.vue`

**新增功能**:
- 图片卡片底部添加描述显示区域
- 描述文本样式：
  - 最多显示50个字符
  - 超出显示"..."
  - 最多显示2行
  - 鼠标悬停显示完整内容

**显示逻辑**:
```javascript
const truncateDescription = (description) => {
  if (!description) return '';
  if (description.length <= 50) return description;
  return description.substring(0, 50) + '...';
};
```

**样式**:
- 字号：12px
- 颜色：#666
- 行高：1.4
- 显示：最多2行，超出隐藏

#### 3. UploadView.vue - 上传页面
**位置**: `front/src/views/UploadView.vue`

**新增功能**:
- 添加"添加描述"开关
- 描述输入框：
  - 类型：多行文本框
  - 最大长度：200字
  - 显示字数统计
  - 占位提示：为这批图片添加统一描述（可选，最多200字）

**使用流程**:
1. 选择要上传的图片
2. 开启"添加描述"开关
3. 输入描述文本（可选）
4. 点击"上传"按钮
5. 所有图片将使用相同的描述

### 后端修改

#### 1. 图片更新接口 - 支持文件名修改
**位置**: `back/routes/images.js`
**路由**: `PUT /api/images/:id`

**新增参数**:
```javascript
{
  "filename": "新文件名.jpg"  // 完整文件名（包含扩展名）
}
```

**验证规则**:
- 文件名不能为空
- 不能包含非法字符：`<>:"/\|?*`
- 自动修复UTF-8编码

**处理逻辑**:
```javascript
if (filename !== undefined && filename !== null) {
  // 修复文件名编码
  const newFilename = fixFilename(filename);
  
  // 验证文件名
  if (!newFilename || newFilename.trim() === '') {
    return res.status(400).json({ error: 'Filename cannot be empty' });
  }
  
  // 检查非法字符
  const invalidChars = /[<>:"/\\|?*]/;
  if (invalidChars.test(newFilename)) {
    return res.status(400).json({ error: 'Filename contains invalid characters' });
  }
  
  // 更新数据库
  await db.query(
    'UPDATE images SET original_filename = ? WHERE id = ?',
    [newFilename, imageId]
  );
}
```

#### 2. 批量上传接口 - 支持描述
**位置**: `back/routes/images.js`
**路由**: `POST /api/images/upload/batch`

**新增参数**:
```javascript
FormData {
  images: [File, File, ...],  // 图片文件数组
  description: "描述文本"      // 可选的描述
}
```

**处理逻辑**:
```javascript
// 获取描述（如果提供）
const description = req.body.description || '';

// 在插入数据库时添加描述
const [result] = await db.query(
  `INSERT INTO images (..., description) 
   VALUES (?, ?, ..., ?)`,
  [..., description]
);
```

## 🎯 使用示例

### 示例 1: 修改文件名

**场景**: 上传了一张文件名为 `IMG_1234.jpg` 的图片，想改为更有意义的名字

**步骤**:
1. 在相册中点击图片，进入详情页面
2. 找到"文件名"字段，点击右侧的"编辑"按钮
3. 输入框变为可编辑状态，输入新名称：`杭州西湖风景`
4. 注意：扩展名 `.jpg` 自动保留，不需要输入
5. 点击"保存"按钮
6. 提示"文件名修改成功"
7. 文件名更新为：`杭州西湖风景.jpg`

### 示例 2: 批量上传带描述的图片

**场景**: 上传一组旅游照片，想添加统一的描述

**步骤**:
1. 进入上传页面
2. 选择多张图片（例如 5 张西湖的照片）
3. 开启"添加描述"开关
4. 在描述框中输入：`2024年春季杭州西湖游，天气晴朗，风景优美`
5. 点击"上传"按钮
6. 所有 5 张图片都会带有这个描述
7. 在相册中查看时，每张图片下方都会显示这段描述（超过50字会截断）

### 示例 3: 查看完整描述

**场景**: 相册中描述被截断，想查看完整内容

**方法 1** - 鼠标悬停:
1. 在相册页面找到图片
2. 将鼠标悬停在描述文字上
3. 会显示完整的描述内容（浏览器 tooltip）

**方法 2** - 进入详情页:
1. 点击图片进入详情页面
2. 在"描述"字段可以看到完整内容
3. 还可以在此处修改描述

## 📝 字段说明

### 文件名 (original_filename)
- **数据库字段**: `VARCHAR(255)`
- **字符集**: `utf8mb4`
- **验证规则**:
  - 不能为空
  - 不能包含: `< > : " / \ | ? *`
  - 自动修复编码问题
- **显示位置**: 图片详情、相册卡片

### 描述 (description)
- **数据库字段**: `TEXT`
- **字符集**: `utf8mb4`
- **最大长度**: 无限制（前端限制200字输入）
- **显示规则**:
  - 相册：最多50字，超出显示`...`
  - 详情：完整显示
- **显示位置**: 图片详情、相册卡片（标签下方）

## 🎨 界面设计

### 图片详情页 - 文件名编辑区
```
┌─────────────────────────────────────┐
│ 文件名                              │
│ ┌─────────────────────┬───────────┐ │
│ │ 杭州西湖风景        │ .jpg   [编辑] │
│ └─────────────────────┴───────────┘ │
└─────────────────────────────────────┘

编辑状态：
┌─────────────────────────────────────┐
│ 文件名                              │
│ ┌─────────────────────┬───────────┐ │
│ │ 杭州西湖风景▌       │ .jpg   [保存] │
│ └─────────────────────┴───────────┘ │
└─────────────────────────────────────┘
```

### 相册页面 - 图片卡片
```
┌──────────────────┐
│                  │
│   [图片缩略图]   │
│                  │
├──────────────────┤
│ 文件名.jpg       │
│ 1920 × 1080      │
│ [风景] [旅游]    │
│ 2024年春季杭州...│ ← 描述（最多50字）
└──────────────────┘
```

### 上传页面 - 描述输入
```
┌─────────────────────────────────────┐
│ [拖拽或点击上传图片]                │
│ ┌─────┐ ┌─────┐ ┌─────┐            │
│ │图片1│ │图片2│ │图片3│            │
│ └─────┘ └─────┘ └─────┘            │
├─────────────────────────────────────┤
│ 添加描述: ○ 是  ● 否               │
│                                     │
│ 图片描述:                           │
│ ┌─────────────────────────────────┐ │
│ │ 2024年春季杭州西湖游，天气晴朗，│ │
│ │ 风景优美...            50/200   │ │
│ └─────────────────────────────────┘ │
│                                     │
│     [清空]  [上传 (3)]             │
└─────────────────────────────────────┘
```

## ⚠️ 注意事项

### 文件名修改
1. **只修改数据库记录**
   - 实际文件名不会改变
   - 只修改 `original_filename` 字段
   - 不影响 `stored_path`

2. **扩展名保护**
   - 扩展名自动从原文件名提取
   - 用户只能修改文件名主体
   - 保存时自动拼接扩展名

3. **非法字符**
   - Windows: `< > : " / \ | ? *`
   - 这些字符在文件系统中有特殊含义
   - 前后端都会验证和拒绝

4. **编码处理**
   - 自动修复 Latin1 → UTF-8 转换
   - 支持中文、日文、韩文等
   - 支持 Emoji 表情

### 描述显示
1. **截断规则**
   - 相册：50字符后截断
   - JavaScript: `substring(0, 50) + '...'`
   - CSS: `-webkit-line-clamp: 2`（最多2行）

2. **完整显示**
   - 鼠标悬停：`title` 属性显示完整内容
   - 点击图片：进入详情页查看完整描述

3. **空值处理**
   - 描述为空不显示该区域
   - 避免空白占位

### 批量上传
1. **统一描述**
   - 同一批次的所有图片使用相同描述
   - 适合：相同场景的照片组
   - 后续可以单独修改每张图片的描述

2. **可选功能**
   - 描述是可选的，不是必填
   - 不添加描述不影响上传

## 🧪 测试清单

### 文件名编辑
- [ ] 打开图片详情页面
- [ ] 点击"编辑"按钮，输入框变为可编辑
- [ ] 修改文件名（不含扩展名）
- [ ] 点击"保存"按钮
- [ ] 验证文件名更新成功
- [ ] 尝试输入空文件名，验证被拒绝
- [ ] 尝试输入非法字符（如 `<`），验证被拒绝
- [ ] 尝试中文文件名，验证正常工作
- [ ] 返回相册，验证新文件名显示正确

### 描述显示
- [ ] 创建一张带描述的图片（描述内容少于50字）
- [ ] 在相册中查看，验证描述完整显示
- [ ] 创建一张描述超过50字的图片
- [ ] 在相册中查看，验证显示截断（带省略号）
- [ ] 鼠标悬停在描述上，验证显示完整内容
- [ ] 点击进入详情页，验证完整描述显示

### 批量上传
- [ ] 进入上传页面
- [ ] 选择多张图片
- [ ] 不开启"添加描述"，直接上传
- [ ] 验证图片上传成功，描述为空
- [ ] 再次上传图片
- [ ] 开启"添加描述"开关
- [ ] 输入描述文本
- [ ] 上传图片
- [ ] 在相册中验证所有图片都有描述
- [ ] 尝试输入超过200字的描述，验证字数限制

## 📊 API 参考

### 更新图片信息
```http
PUT /api/images/:id
Authorization: Bearer {token}
Content-Type: application/json

{
  "filename": "新文件名.jpg",
  "description": "图片描述",
  "tags": ["标签1", "标签2"]
}
```

**响应**:
```json
{
  "message": "Image updated successfully",
  "image": {
    "id": 1,
    "original_filename": "新文件名.jpg",
    "description": "图片描述",
    ...
  }
}
```

### 批量上传（带描述）
```http
POST /api/images/upload/batch
Authorization: Bearer {token}
Content-Type: multipart/form-data

images: [File, File, ...]
description: "描述文本"
```

**响应**:
```json
{
  "message": "3 images uploaded successfully",
  "images": [
    {
      "id": 1,
      "filename": "文件1.jpg",
      "stored_path": "uploads/user_1/img_xxx.jpg",
      "thumbnail_path": "uploads/user_1/img_xxx_thumb.jpg"
    },
    ...
  ]
}
```

## 🎉 总结

### 新功能
✅ **文件名编辑** - 图片详情页面可修改文件名（保留扩展名）  
✅ **描述显示** - 相册页面显示图片描述（超过50字截断）  
✅ **上传描述** - 上传时可为批次图片添加统一描述  

### 技术实现
✅ 前端文件名验证（非法字符、空值）  
✅ 后端文件名验证（双重检查）  
✅ 描述智能截断（JavaScript + CSS）  
✅ UTF-8 编码支持（中英文混合）  

### 用户体验
✅ 直观的编辑界面（编辑/保存按钮）  
✅ 实时反馈（字数统计、验证提示）  
✅ 悬停提示（完整描述）  
✅ 灵活的批量操作（可选描述）  

**现在您可以轻松管理图片文件名和描述了！** 🎉

